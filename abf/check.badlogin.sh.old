#!/bin/bash


#Anti-BruteForce for Centos Made By Kirill Kamaldinov

##check ? times
bcan=/scripts/check.badlogin

##Email address to send notification to 
mail=notifierap@gmail.com
if [ ! -f $bcan/checker.art ]; then
	touch $bcan/checker.art
fi
echo "-- $(date +%Y-%m-%d:%H:%M:%S) --" >> $bcan/checker.art
##how many times

howman=$(cat /var/log/auth.log | egrep "Fail|fail" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' |sort | uniq -c | sort -n |tail -1 | awk '{print $1}')
if [ $? = "0" ]; then 
	echo "howman - OK" >> $bcan/checker.art; else "howman - error!" >> $bcan/checker.art
fi
##which IP
whois=$(cat /var/log/auth.log | egrep "Fail|fail" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' |sort | uniq -c | sort -n |tail -1 | awk '{print $2}')
set -x
if [ $? = "0" ]; then 
        echo "whois - OK" >> $bcan/checker.art; else "whois - error!" >> $bcan/checker.art
fi
##how many bad logins before block
if [[ $howman -gt 7 ]]; then
		if [ ! -f $bcan/whoisip.art ]; then
			touch $bcan/whoisip.art
		fi
   		wrz=$(cat $bcan/whoisip.art)
			if [[ $whois != $wrz ]]; then
			curl -s ipinfo.io/"$whois"/region > $bcan/gregion.art
		        	if [ $? = "0" ]; then
                			echo "1st Location checker - OK" >> $bcan/checker.art; else "1st Location checker - ERROR" >> $bcan/checker.art
        			fi	
				if [ ! -f $bcan/gregion.art ]; then
				touch $bcan/gregion.art
				fi
				if [ ! -f $bcan/gcountry.art ]; then
				touch $bcan/gcountry.art
				fi
			sleep 0.5
			curl -s ipinfo.io/"$whois"/country > $bcan/gcountry.art
			if [ $? = "0" ]; then
                                        echo "2nd Location checker - OK" >> $bcan/checker.art; else "2nd Location checker - ERROR" >> $bcan/checker.art
                                fi
			sleep 0.5
			##region
			gregion=$(cat $bcan/gregion.art)
			##country
			gcountry=$(cat $bcan/gcountry.art)
			/sbin/iptables -I INPUT -s $whois -j DROP
				        if [ $? = "0" ]; then
                				echo "IPTABLES - OK" >> $bcan/checker.art; else "CRITICAL! - CHECK IPTABLES!" >> $bcan/checker.art
				        fi
				if [ ! -f /var/log/chkbl.log ]; then
				touch /var/log/chkbl.log
				fi
			echo "$(date +%Y-%m-%d:%H:%M:%S) -  ApresMainHost - IP: $whois - $gregion , $gcountry  were blocked after $howman bad logins." >> /var/log/chkbl.log
#			echo "--ANTI BruteForce-- IP: $whois - $gregion , $gcountry  were blocked after $howman bad logins." | /usr/sbin/sendmail -F ANTI-DDOS $mail
			if [ ! -f $bacn/noty.log ]; then 
				touch $bcan/noty.log
			fi	
			echo "$(date +%Y-%m-%d:%H:%M:%S) -  ApresMainHost - IP: $whois - $gregion , $gcountry  were blocked after $howman bad logins." >> $bcan/noty.log
			blog=/var/log
				if [ ! -d $blog/secure.b ]; then
				mkdir $blog/secure.b
				fi  
			cp $blog/auth.log $blog/secure.b/secure-$(date +%F_%R)
			sdirc=$(ls $blog/secure.b | wc -l)
				if [[ $sdirc -gt 30 ]]; then
					tar -czvf $blog/secure.$(date +%F_%R).tar.gz $blog/secure.b/*
					rm -f $blog/secure.b/*
				fi
			>$blog/auth.log
			echo $whois > $bcan/whoisip.art
				if [[ ! -f $bcan/bcount.art ]]; then
				touch $bcan/bcount.art
				fi
			bcount=$(cat $bcan/bcount.art)
			expr $bcount + 1 > $bcan/bcount.art

#				if [ $bcount -gt 750 ]; then
#				iptables -F
#				echo "Bcount has reached 750. all IP's were released" | /usr/sbin/sendmail -F Release-Anti-DDOS headhood20@gmail.com
#				fi
		fi

else
#			bcount=$(cat $bcan/bcount.art)
#			expr $bcount + 1 > $bcan/bcount.art
 exit 0
fi
